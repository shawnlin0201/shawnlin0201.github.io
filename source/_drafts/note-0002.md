---
title: 圖片優化的藝術（Image Optimization）
date: 2019-07-18 11:58:50
tags:
- [UI/UX]
- [前端]
- [後端]
- [全端]
- [CSS]
- [JavaScript]
- [優化]
- [optimizing]
categories: 
- [UIUX, 優化]
- [前端, 優化]
- [後端, 優化]
- [全端, 優化]
---

![](/images/note-0001.jpeg)

# 前言
工程師在工作上與視覺牢不可分，時常圖片為舞，為了使圖片能夠更好的支援網站、app產品，除了要瞭解基礎的視覺相關知識，還可以利用各種方式對於圖片進行優化，加強使用者在使用網站上的體驗，本篇文章介紹了幾項設計師、前後端對於圖片以及文字能夠優化的部分：

# 圖片優化 (Image Optimization)

常見對於圖片優化相關方案：
- [圖片的解析設定](#%E5%9C%96%E7%89%87%E8%A7%A3%E6%9E%90%E8%A8%AD%E5%AE%9A-img-srcset)
- [圖片的格式類型](#%E5%9C%96%E7%89%87%E6%A0%BC%E5%BC%8F%E9%A1%9E%E5%9E%8B-image-type)
- [圖片的檔案壓縮](#%E5%9C%96%E7%89%87%E6%AA%94%E6%A1%88%E5%A3%93%E7%B8%AE-image-size-cost-reduction)
- [圖片的呼叫次數](#%E5%9C%96%E7%89%87%E5%91%BC%E5%8F%AB%E6%AC%A1%E6%95%B8-http-request)
- [圖片的延遲載入](#%E5%9C%96%E7%89%87%E5%BB%B6%E9%81%B2%E8%BC%89%E5%85%A5-lazy-loading)

## 圖片解析設定 (img srcset)
圖片解析相關設定是在繪圖與儲存時，以及圖片如何在客戶端頁面呈現的選擇，故設計師與前端工程師可考慮這個方案，而在說明解決方案前可以先大抵認識一下相關顯示單位：

第一組是密度常見的單位，主要用於是顯示參考上會需要考量到的：
- **DPI（Dots per inch）**：為一英吋中點的數量，通常是用於印刷單位使用。
- **PPI（Pixels Per Inch）**：為一英吋中**物理像素**的數量。我們常聽到的解析度（Resolution）便會使用此單位。


![](/images/note-0001-dpi.jpg)

光看文字可能太過於抽象，接著以一個範例解說dpi的例子。假設上方圖中為一平方英吋的方框，而左邊橫排格數為1、右邊橫排格數為2，因此左邊方框代表的dpi為1，右邊方框代表的dpi就是2，紅色中的方塊範圍即為1px（Pixel）；而1pt（Point）的大小即為1/72英吋，也就是一個一平方英吋的方格切成72{% raw %}*{% endraw %}72的方格時，每個方格代表即為1pt，此時正好同等1px。因此在**72dpi情況下其實1pt就會同等於1px**。

PPI的算法則是：**開根號(渲染像素長<sup>2</sup>+渲染像素寬<sup>2</sup>)/物理尺寸(英吋)**，例如iPhone 6的**渲染尺寸**為320{% raw %}*{% endraw %}480，**實際尺寸**為3.5吋，以JavaScript計算即為`Math.sqrt(320*320+480*480)/3.5=164.83`約164ppi`。

而從技術上來說DPI的dot（點）只會出現在印刷領域中、PPI中的pixel（像素）則是出現在顯示裝置中，但兩個說明的其實是類似的概念。

第二組是螢幕設備常見單位，主要用於**網頁與app端顯示**時需要考量到的：

- **DP（Device Pixels）**：
為設備螢幕的**物理像素**，例如iPhone5的物理像素為640px{% raw %}*{% endraw %}1136px，但是這不是一個**真實長度**單位。

- **CSS Pixels**：
為CSS樣式中使用的單位大小如px等等的**邏輯像素**，呈現大小將會**依據設備的DPR不同而不同**。

- **DPR（Device Pixel Ratio）**：
為CSS像素在設備上對應的物理像素**比例**，即CSS將會依DPR縮小成多少的單位（這裡的縮小指的是**看**起來）。

根據上面的定義意思即為當DPR為1時，我用CSS撰寫一個寬120p{% raw %}*{% endraw %}長120px的正方形時，該元素在畫面上則會呈現寬120px{% raw %}*{% endraw %}長120px的正方形（如下圖左邊的正方形）；DPR為2時，表示一個像素點會由四個CSS像素組成，因此最後會呈現一樣會是120px{% raw %}*{% endraw %}120px的正方形，但是由於螢幕的物理像素密度更高了，所以讓圖形看起來變小了（如下圖中間的正方形）；而DPR為3時則會如下圖右邊的正方形。

![](/images/note-0001-dpr.jpg)

正常**電腦螢幕裝置預設值為1**，DPR測量可以藉由JavaScript中的`window.devicePixelRatio`來得到，而Retina電腦DPR則有@1x、@2x到@3x的倍率，若想要將DPR@3x中**看起來**被縮小的圖放大到跟一般電腦@1x的大小一樣，那麼在Retina螢幕上觀看圖片將會非常模糊。（**註**：Apple公司所發明的Retina螢幕顯示器則是指在正常距離下人類的眼睛無法分辨單獨一個物理像素，但並不是高PPI就是Retina螢幕。）

若今天專案有需求要將網頁中的圖片分別呈現給不同DPR螢幕時，有以下幾種作法：

- 利用img元素的srcset
- 利用picture元素裡source元素相關設定
- Media Query
- 直接暴力輸出@2x、@3x的圖檔（**不建議**）

### img srcset
在img元素標籤中有個`srcset`可以設定，準備額外倍率的圖片檔後，加入此屬性並且在檔名後面寫上DPR輸出倍率，而預設是沒有符合倍率的情況會使用原先src預設的圖檔：
```
<img src='images/sample.jpeg' srcset='images/sample_2x.jpeg 2x,images/sample_3x.jpeg 3x'/>
```

除此之外也可以依據Viewport來選擇輸出尺寸，但依據的不是倍率而是Viewport的寬度：

```
<img src='images/sample.jpeg' srcset='images/sample.jpeg 320w,images/sample.jpeg 1200w'/>
```

### picture元素
將img與source包裹在picture元素當中，使用方法與img srcset很像，將media query選項包在source元素標籤內，而預設是沒有符合篩選選項則會使用img標籤內的圖檔，而此作法同樣可以在裡面塞入不同的DPR倍率：

```
<picture>
    <source media='(min-width: 1200px)' srcset='image/sample_large.jpeg 2x, image/sample_large.jpeg 3x' >
    <source media='(min-width: 640px)' srcset='image/sample_medium.jpeg 2x, image/sample_medium.jpeg 3x,' >
    <img src='image/sample.jpeg'>
</picture>
```


### Media Query (**稍微不建議**)
使用CSS的media query去寫出圖片的路徑與大小等等：
```
@media
    (-webkit-min-device-pixel-ratio: 1),
    (min-resolution: 96dpi){
    
    //CSS內容

}
```

**要注意的是**此作法與上面兩種做法不同是，CSS的作法並不會透過瀏覽器去選擇要產出的檔案，而是全部下載下來再透過CSS去編輯，因此也不建議去使用。

### 暴力輸出（**不建議**）
直接將@3x的圖檔放上去讓比例自動縮放。

好處：一張圖搞定。
壞處：容量怪獸、使用者沒吃到飽會損耗額度、載入時間拉長……一坨拉庫的原因，如果要**優化**，那這個選擇將會不是很妥當。

折衷辦法：就放個@2x的圖吧！


## 圖片格式類型 (image type)
設計師與前端在儲存圖片時，依據圖片上的不同，可以採用不同的圖片儲存格式：
- gif：若要放置動圖時，可採。**但一般都還是建議使用CSS3的transition與animation等等作法來製作動圖會有更好的呈現**
- SVG：當圖片為簡單純色塊組成時，可使用此向量格式檔，它會讓圖片放大時不會失真。
- jpeg：當圖片為較複雜時，背景**不須透明**且較**不要求照片細節**時。
- png：當圖片較為複雜時，背景**需透明**或是**要求照片細節**時。

## 圖片檔案壓縮 (image size cost reduction)
設計師與前後端在依據圖片的類型時可使用不同方式先壓縮過後在上傳至主機：
- svg：上傳至主機前使用Gzip壓縮，盡量避免圖形複雜度以及特效等等。
- jpeg：最佳化jpeg[jpegtran](http://jpegclub.org/jpegtran/)
- png：無失真壓縮的[optipng](http://optipng.sourceforge.net/)、失真壓縮的[pngquant](https://pngquant.org/)

想要快速線上壓縮也可以考慮：[tinypng](https://tinypng.com/)。

## 減少圖片呼叫次數 (http request)
在瀏覽器與伺服器之間的溝通中（http request與http response）是非常昂貴的，除了會耗費客戶端大量的時間在處理這些資訊，同時也會使使用者在行動傳輸費用上大幅提升，因此可以利用一些方法來減少圖片呼叫次數：

### 利用快取（HTTP Caching）
偏向後端的參考方案，使用瀏覽器內建的快取功能，利用HTTP Response Header中的Expires、Cache-Control、max-age與Etag等等的機制使客戶端不會每次瀏覽網站就一併把圖片再下載一次。而快取的機制內容可深可淺，有機會我會另寫一篇快取文章來介紹。

### CSS Sprite
設計師與前端可參考這個方案，透過將圖片檔案包裝成同一隻圖片檔，再藉由CSS的方式控制圖片顯示範圍，例如下列範例中，圖片原本是四個分開的圖片方格（40px乘40px），合併後變成一張寬40px長160px的圖檔：

![](/images/note-0001-css-sprite.jpg)

首先CSS的部分先定義圖片來源與大小：
```
    .article-bg{
        width:40px;
        height:40px;
        background-image: url('./image/css-sprite.jpg')
    }
```
而在HTML結構部分擇要加入要放置圖片的位置以及待會要選取圖片範圍用的class名稱：
```
    <section class="article-wrap">
        <article class="article-1">
            <p class="article-title">article 1</p>
            <div class="article-bg article-1"></div> // 將圖片放置在共同的class(or ID)下 (ex .article-bg)
        </article>
        <article class="article-2">
            <p class="article-title">article 2</p>
            <div class="article-bg article-2"></div> // 將圖片放置在共同的class(or ID)下 (ex .article-bg)
        </article>
        <article class="article-3">
            <p class="article-title">article 3</p>
            <div class="article-bg article-3"></div> // 將圖片放置在共同的class(or ID)下 (ex .article-bg)
        </article>
        <article class="article-4">
            <p class="article-title">article 4</p>
            <div class="article-bg article-4"></div> // 將圖片放置在共同的class(or ID)下 (ex .article-bg)
        </article>
    </section>
```

接著加入每個區塊要取用的圖片class，透過background-position這個屬性，來得到圖片的範圍（屬性值分別為圖片水平移動距離與圖片垂直移動距離）：

```
    .article-1{
        background-position: 0 0;
    }
    .article-2{
        background-position: 0 40px;
    }
    .article-3{
        background-position: 0 80px;
    }
    .article-4{
        background-position: 0 120px;
    }
```
接著就可以得到看起來不同圖片，但實際上只取得一次圖片資源的效果。
![](/images/note-0001-css-sprite-2.jpg)

### 圖片替代方案
將圖片使用文字方式呈現，藉此隨著html元素一併載入，以此減少對於伺服器的請求，例如將圖片以文字方式取代的知名網站[Fontawesome](https://fontawesome.com/)、收集各家大廠Icon的[Iconfont](https://www.iconfont.cn/)等。

另外也可以將圖片儲存成base64的格式，將圖片儲存成文字編碼來降低請求，可以透過線上網站[base64 image](https://www.base64-image.de/)等等將圖片轉換編碼。

雖說這個方法非常的實用，但它的限制在於轉換容量非常的可觀，小小幾KB的圖片轉乘base64後都能大上個幾倍，更不用說是大張的圖形，所以這個base64方法僅適合在較小的圖片上使用，例如Icon等等。

## 圖片延遲載入 (lazy loading)
這項參考主要則是將客戶端的使用者在瀏覽網站時，可能該網站中單一頁就有數十、數百張圖片（電商、社群網站等等），而有些圖片內容是使用者尚未瀏覽到的地方，因此透過JavaScript等方法來延後該圖片的載入，來達到類似快速載入的效果：

不想自己造輪子想快速開發可以使用jQuery中知名的[Lazy Load套件](https://github.com/tuupola/lazyload)，用法也很簡單只要將圖片class加上lazyload，加入data-src屬性，數值則帶入引用圖片的位置即可。

使用前端框架(Vue、React或Angular)則可以考慮透過trigger class方式去驅動是否顯示：例如偵聽頁面當前高度，然後透過Vue中的v-bind:class來動態添加class名稱在以css方式將圖載入等等。




# 參考資料
- [完全理解px,dpr,dpi,dip](http://www.ayqy.net/blog/%E5%AE%8C%E5%85%A8%E7%90%86%E8%A7%A3px-dpr-dpi-dip/)
- [px、pt、dp、sp 大混戰](https://blog.akanelee.me/2018/07/31/dpi-px-pt-dp-sp/)
- [PPI wiki](https://zh.wikipedia.org/wiki/%E6%AF%8F%E8%8B%B1%E5%AF%B8%E5%83%8F%E7%B4%A0)
- [DPI wiki](https://en.wikipedia.org/wiki/Dots_per_inch)
- [http-caching](https://cythilya.github.io/2018/07/27/http-caching/)
- [MDN-DPR](https://developer.mozilla.org/en-US/docs/Web/CSS/Media_Queries/Using_media_queries#-moz-device-pixel-ratio)
- [響應式圖片（Responsive Images）](https://cythilya.github.io/2018/08/24/responsive-images/)
- [guide-to-iphone-resolutions](https://www.paintcodeapp.com/news/ultimate-guide-to-iphone-resolutions)
- [images Optimization](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/image-optimization)
- [webfont Optimization](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/webfont-optimization)
- [Retina wiki](https://en.wikipedia.org/wiki/Retina_display)